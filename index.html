<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Approved Route Calculator - Roshi Transport Corporation</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #FFF8E7 0%, #F5E6D3 100%);
            min-height: 100vh;
            padding: 15px;
            padding-bottom: 90px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #2C1810;
            padding: 30px 20px;
            text-align: center;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 4px 20px rgba(255, 165, 0, 0.3);
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .header p {
            font-size: 14px;
            font-weight: 400;
            color: #5D4037;
        }

        .content-wrapper {
            background: white;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 8px 32px rgba(255, 165, 0, 0.3);
            overflow: hidden;
        }

        .input-section {
            padding: 30px 20px;
            background: linear-gradient(135deg, #FFFBF0 0%, #FFF8E7 100%);
            border-bottom: 3px solid #FFE4B5;
        }

        .input-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            position: relative;
        }

        label {
            font-weight: 600;
            color: #2C1810;
            margin-bottom: 8px;
            font-size: 13px;
        }

        input {
            padding: 16px 18px;
            border: 2px solid #FFE4B5;
            border-radius: 10px;
            font-family: 'Poppins', sans-serif;
            font-size: 15px;
            transition: all 0.3s;
            background: white;
            color: #2C1810;
            width: 100%;
            touch-action: manipulation;
        }

        input:focus {
            outline: none;
            border-color: #FFD700;
            box-shadow: 0 0 0 4px rgba(255, 215, 0, 0.15);
        }

        .calculate-btn {
            padding: 18px 40px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #2C1810;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            font-family: 'Poppins', sans-serif;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(255, 165, 0, 0.4);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 10px;
            touch-action: manipulation;
            min-height: 54px;
        }

        .calculate-btn:active {
            transform: translateY(1px);
        }

        .calculate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .navigate-btn {
            padding: 18px 40px;
            background: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            font-family: 'Poppins', sans-serif;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 15px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            touch-action: manipulation;
            min-height: 54px;
        }

        .navigate-btn:active {
            transform: translateY(1px);
        }

        /* ðŸ”§ MOBILE FIX: Approved Route section - prevent overflow and ensure proper stacking */
        .route-info {
            display: none;
            padding: 25px 20px;
            background: linear-gradient(135deg, #C8E6C9 0%, #A5D6A7 100%);
            border: 3px solid #4CAF50;
            /* ðŸ”§ MOBILE FIX: Prevent horizontal overflow */
            max-width: 100%;
            overflow-x: hidden;
            word-wrap: break-word;
        }

        .route-info.active {
            display: block;
        }

        .route-header {
            text-align: center;
            margin-bottom: 20px;
            /* ðŸ”§ MOBILE FIX: Prevent text overflow */
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .route-title {
            font-size: 20px;
            font-weight: 700;
            color: #1B5E20;
            margin-bottom: 6px;
            /* ðŸ”§ MOBILE FIX: Ensure title wraps on small screens */
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }

        .route-subtitle {
            font-size: 12px;
            color: #2E7D32;
            font-weight: 500;
            /* ðŸ”§ MOBILE FIX: Ensure subtitle wraps properly */
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .route-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
            /* ðŸ”§ MOBILE FIX: Prevent stats grid overflow */
            width: 100%;
            max-width: 100%;
        }

        .stat-card {
            background: white;
            padding: 18px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            /* ðŸ”§ MOBILE FIX: Prevent card overflow */
            min-width: 0;
            word-wrap: break-word;
        }

        .stat-label {
            font-size: 11px;
            color: #5D4037;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 6px;
            /* ðŸ”§ MOBILE FIX: Ensure labels don't overflow */
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #2C1810;
            /* ðŸ”§ MOBILE FIX: Prevent value overflow */
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .route-points {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            /* ðŸ”§ MOBILE FIX: Prevent route points overflow */
            max-width: 100%;
            overflow-x: hidden;
        }

        .route-point {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid #FFE4B5;
            /* ðŸ”§ MOBILE FIX: Ensure proper wrapping */
            flex-wrap: nowrap;
            min-width: 0;
        }

        .route-point:last-child {
            border-bottom: none;
        }

        .route-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            flex-shrink: 0;
        }

        .route-icon.origin {
            background: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%);
            color: white;
        }

        .route-icon.destination {
            background: linear-gradient(135deg, #F44336 0%, #EF5350 100%);
            color: white;
        }

        .route-text {
            flex: 1;
            min-width: 0;
            /* ðŸ”§ MOBILE FIX: Ensure text wraps and doesn't overflow */
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .route-label {
            font-size: 10px;
            color: #8D6E63;
            font-weight: 600;
            text-transform: uppercase;
            /* ðŸ”§ MOBILE FIX: Prevent label overflow */
            word-wrap: break-word;
        }

        .route-address {
            font-size: 14px;
            color: #2C1810;
            font-weight: 500;
            margin-top: 2px;
            word-wrap: break-word;
            /* ðŸ”§ MOBILE FIX: Enhanced wrapping for long addresses */
            overflow-wrap: break-word;
            hyphens: auto;
        }

        .landmarks-btn {
            padding: 14px 30px;
            background: white;
            color: #2C1810;
            border: 2px solid #FFD700;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            font-family: 'Poppins', sans-serif;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 15px;
            width: 100%;
            touch-action: manipulation;
            min-height: 48px;
        }

        .landmarks-btn:active {
            background: linear-gradient(135deg, #FFFBF0 0%, #FFF8E7 100%);
        }

        .landmarks-section {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 15px;
            border: 2px solid #FFE4B5;
            /* ðŸ”§ MOBILE FIX: Prevent landmarks overflow */
            max-width: 100%;
            overflow-x: hidden;
        }

        .landmarks-section.active {
            display: block;
        }

        .landmarks-title {
            font-size: 16px;
            font-weight: 700;
            color: #2C1810;
            margin-bottom: 5px;
            /* ðŸ”§ MOBILE FIX: Ensure title wraps */
            word-wrap: break-word;
        }

        .landmarks-subtitle {
            font-size: 11px;
            color: #8D6E63;
            margin-bottom: 15px;
            /* ðŸ”§ MOBILE FIX: Ensure subtitle wraps */
            word-wrap: break-word;
        }

        .landmark-item {
            padding: 12px;
            background: linear-gradient(135deg, #FFFBF0 0%, #FFF8E7 100%);
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #FFD700;
            /* ðŸ”§ MOBILE FIX: Prevent landmark item overflow */
            max-width: 100%;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .landmark-item:last-child {
            margin-bottom: 0;
        }

        .landmark-name {
            font-size: 14px;
            font-weight: 600;
            color: #2C1810;
            margin-bottom: 2px;
            /* ðŸ”§ MOBILE FIX: Ensure landmark names wrap */
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .landmark-type {
            font-size: 11px;
            color: #5D4037;
            font-weight: 500;
            /* ðŸ”§ MOBILE FIX: Ensure types wrap */
            word-wrap: break-word;
        }

        .map-container {
            padding: 25px 20px;
            background: white;
        }

        #map {
            width: 100%;
            height: 450px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .disclaimer {
            background: linear-gradient(135deg, #FFFBF0 0%, #FFF8E7 100%);
            border-left: 5px solid #FFD700;
            padding: 20px;
            margin: 0;
            font-size: 12px;
            color: #5D4037;
            line-height: 1.6;
            text-align: center;
            font-weight: 500;
        }

        .error-message {
            display: none;
            background: linear-gradient(135deg, #FFCDD2 0%, #EF9A9A 100%);
            border: 3px solid #F44336;
            color: #B71C1C;
            padding: 20px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
        }

        .error-message.active {
            display: block;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #FFFBF0 0%, #FFF8E7 100%);
        }

        .loading.active {
            display: block;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #FFE4B5;
            border-top: 5px solid #FFD700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 14px;
            color: #5D4037;
            font-weight: 600;
        }

        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #2C1810 0%, #5D4037 100%);
            color: #FFE4B5;
            text-align: center;
            padding: 12px 15px;
            font-size: 10px;
            font-weight: 400;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            line-height: 1.5;
        }

        .footer-separator {
            margin: 0 6px;
            opacity: 0.5;
        }

        .suggestion-list {
            position: absolute;
            background: white;
            border: 2px solid #FFD700;
            border-radius: 10px;
            max-height: 250px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            width: 100%;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 20px rgba(255, 165, 0, 0.3);
            top: 100%;
            margin-top: 5px;
        }

        .suggestion-list.active {
            display: block;
        }

        .suggestion-item {
            padding: 14px 15px;
            cursor: pointer;
            border-bottom: 1px solid #FFE4B5;
            font-size: 14px;
            color: #2C1810;
            touch-action: manipulation;
        }

        .suggestion-item:active {
            background: linear-gradient(135deg, #FFFBF0 0%, #FFF8E7 100%);
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-name {
            font-weight: 600;
            margin-bottom: 3px;
        }

        .suggestion-detail {
            font-size: 11px;
            color: #8D6E63;
        }

        /* ðŸ”§ MOBILE-SPECIFIC OPTIMIZATIONS (max-width: 768px) */
        @media (max-width: 768px) {
            /* ðŸ”§ MOBILE FIX: Reduce header padding on small screens */
            .header h1 {
                font-size: 22px;
                line-height: 1.3;
            }

            .header p {
                font-size: 12px;
                line-height: 1.4;
            }

            /* ðŸ”§ MOBILE FIX: Optimize route info padding for mobile */
            .route-info {
                padding: 20px 15px;
            }

            /* ðŸ”§ MOBILE FIX: Stack route title on very small screens */
            .route-title {
                font-size: 18px;
                line-height: 1.3;
            }

            .route-subtitle {
                font-size: 11px;
                line-height: 1.4;
            }

            /* ðŸ”§ MOBILE FIX: Ensure stat cards stack properly on narrow screens */
            .route-stats {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            /* ðŸ”§ MOBILE FIX: Optimize stat card sizing for mobile */
            .stat-card {
                padding: 15px 12px;
            }

            .stat-value {
                font-size: 22px;
            }

            /* ðŸ”§ MOBILE FIX: Optimize route points spacing */
            .route-points {
                padding: 12px;
            }

            .route-point {
                gap: 10px;
                padding: 8px 0;
            }

            /* ðŸ”§ MOBILE FIX: Reduce icon size slightly on very small screens */
            .route-icon {
                width: 36px;
                height: 36px;
                font-size: 13px;
            }

            /* ðŸ”§ MOBILE FIX: Optimize address font sizing */
            .route-address {
                font-size: 13px;
                line-height: 1.4;
            }

            /* ðŸ”§ MOBILE FIX: Ensure buttons are finger-friendly */
            .navigate-btn {
                font-size: 15px;
                padding: 16px 30px;
                letter-spacing: 0.3px;
            }

            .landmarks-btn {
                font-size: 13px;
                padding: 12px 20px;
            }

            /* ðŸ”§ MOBILE FIX: Optimize landmarks section */
            .landmarks-section {
                padding: 15px;
            }

            .landmarks-title {
                font-size: 15px;
            }

            .landmarks-subtitle {
                font-size: 10px;
            }

            .landmark-item {
                padding: 10px;
            }

            .landmark-name {
                font-size: 13px;
            }

            .landmark-type {
                font-size: 10px;
            }

            /* ðŸ”§ MOBILE FIX: Optimize map height for mobile */
            #map {
                height: 350px;
            }
        }

        /* ðŸ”§ MOBILE FIX: Extra small screens (360px-430px) - Common Android phones */
        @media (max-width: 430px) {
            .route-title {
                font-size: 16px;
            }

            .route-stats {
                gap: 10px;
            }

            .stat-card {
                padding: 12px 10px;
            }

            .stat-value {
                font-size: 20px;
            }

            .stat-label {
                font-size: 10px;
            }

            .route-address {
                font-size: 12px;
            }

            .navigate-btn {
                font-size: 14px;
                padding: 14px 25px;
            }
        }

        /* Desktop optimizations (unchanged) */
        @media (min-width: 768px) {
            body {
                padding: 20px;
                padding-bottom: 80px;
            }

            .header {
                padding: 40px;
            }

            .header h1 {
                font-size: 32px;
            }

            .header p {
                font-size: 16px;
            }

            .input-section {
                padding: 40px;
            }

            .input-grid {
                grid-template-columns: 1fr 1fr auto;
                gap: 20px;
                align-items: end;
            }

            .calculate-btn {
                margin-top: 0;
                white-space: nowrap;
            }

            .calculate-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(255, 165, 0, 0.5);
            }

            .navigate-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(76, 175, 80, 0.5);
            }

            .landmarks-btn:hover {
                background: linear-gradient(135deg, #FFFBF0 0%, #FFF8E7 100%);
            }

            .suggestion-item:hover {
                background: linear-gradient(135deg, #FFFBF0 0%, #FFF8E7 100%);
            }

            .route-info {
                padding: 30px 40px;
            }

            .route-title {
                font-size: 24px;
            }

            .route-subtitle {
                font-size: 14px;
            }

            .route-stats {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
                gap: 20px;
            }

            .stat-value {
                font-size: 28px;
            }

            .map-container {
                padding: 40px;
            }

            #map {
                height: 600px;
            }

            .disclaimer {
                padding: 25px 40px;
                font-size: 13px;
            }

            .footer {
                padding: 15px 20px;
                font-size: 11px;
            }

            .navigate-btn {
                width: auto;
            }
        }

        .leaflet-control-attribution {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Approved Route Calculator</h1>
            <p>Authoritative Distance & Route for Commercial Transport Billing</p>
        </div>

        <div class="content-wrapper">
            <div class="input-section">
                <div class="input-grid">
                    <div class="form-group">
                        <label>Origin (City or Location)</label>
                        <input type="text" id="origin" placeholder="e.g., Mumbai, Maharashtra" autocomplete="off">
                        <div class="suggestion-list" id="originSuggestions"></div>
                    </div>
                    <div class="form-group">
                        <label>Destination (City or Location)</label>
                        <input type="text" id="destination" placeholder="e.g., Delhi, India" autocomplete="off">
                        <div class="suggestion-list" id="destinationSuggestions"></div>
                    </div>
                    <button class="calculate-btn" id="calculateBtn">Calculate Route</button>
                </div>
            </div>

            <div class="error-message" id="errorMessage"></div>
            <div class="loading" id="loading">
                <div class="loading-spinner"></div>
                <div class="loading-text">Calculating Approved Route...</div>
            </div>

            <div class="route-info" id="routeInfo">
                <div class="route-header">
                    <div class="route-title">âœ“ Approved Route â€“ Reliable, Safe & Shortest</div>
                    <div class="route-subtitle">This is the ONLY authorized route for billing and trip planning</div>
                </div>
                <div class="route-stats">
                    <div class="stat-card">
                        <div class="stat-label">Total Distance</div>
                        <div class="stat-value" id="distance">â€”</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Estimated Time</div>
                        <div class="stat-value" id="duration">â€”</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Est. Toll Points</div>
                        <div class="stat-value" id="tolls">â€”</div>
                    </div>
                </div>
                <div class="route-points">
                    <div class="route-point">
                        <div class="route-icon origin">A</div>
                        <div class="route-text">
                            <div class="route-label">Origin Point</div>
                            <div class="route-address" id="originAddress">â€”</div>
                        </div>
                    </div>
                    <div class="route-point">
                        <div class="route-icon destination">B</div>
                        <div class="route-text">
                            <div class="route-label">Destination Point</div>
                            <div class="route-address" id="destinationAddress">â€”</div>
                        </div>
                    </div>
                </div>
                <button class="landmarks-btn" id="landmarksBtn">VIEW ROUTE LANDMARKS</button>
                <div class="landmarks-section" id="landmarksSection">
                    <div class="landmarks-title">Key Checkpoints Along Route</div>
                    <div class="landmarks-subtitle">Estimated major landmarks and waypoints</div>
                    <div id="landmarksList"></div>
                </div>
                <button class="navigate-btn" id="navigateBtn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                        <path d="M2 17l10 5 10-5"/>
                        <path d="M2 12l10 5 10-5"/>
                    </svg>
                    CONFIRM & PROCEED
                </button>
            </div>

            <div class="map-container">
                <div id="map"></div>
            </div>

            <div class="disclaimer">
                Billing and trip planning are calculated strictly as per this Approved Route. Alternate routes are not considered. This route represents the most reliable, safe, and shortest practical path for commercial vehicles.
            </div>
        </div>
    </div>

    <div class="footer">
        All rights reserved Â© Roshi Transport Corporation<span class="footer-separator">|</span>Map data Â© OpenStreetMap contributors<span class="footer-separator">|</span>Powered by Leaflet
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map;
        let routeLayer;
        let originMarker;
        let destinationMarker;
        let originCoords = null;
        let destinationCoords = null;
        let currentRouteData = null;
        
        const searchCache = new Map();
        const CACHE_EXPIRY = 3600000;
        
        let pendingSearchController = null;

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function initMap() {
            map = L.map('map', {
                attributionControl: false,
                zoomControl: true,
                preferCanvas: true,
                tap: true,
                touchZoom: true
            }).setView([20.5937, 78.9629], 5);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                updateWhenIdle: true,
                keepBuffer: 2
            }).addTo(map);

            let resizeTimeout;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(function() {
                    map.invalidateSize();
                }, 250);
            });

            window.addEventListener('orientationchange', function() {
                setTimeout(function() {
                    map.invalidateSize();
                }, 300);
            });
        }

        async function searchLocation(query, callback) {
            if (query.length < 3) {
                callback([]);
                return;
            }

            const cacheKey = query.toLowerCase();
            const cached = searchCache.get(cacheKey);
            
            if (cached && (Date.now() - cached.timestamp) < CACHE_EXPIRY) {
                callback(cached.data);
                return;
            }

            if (pendingSearchController) {
                pendingSearchController.abort();
            }

            try {
                pendingSearchController = new AbortController();
                const timeoutId = setTimeout(() => pendingSearchController.abort(), 5000);
                
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=in&limit=8&addressdetails=1`,
                    { signal: pendingSearchController.signal }
                );
                
                clearTimeout(timeoutId);
                const data = await response.json();
                
                searchCache.set(cacheKey, {
                    data: data,
                    timestamp: Date.now()
                });
                
                pendingSearchController = null;
                callback(data);
            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error('Search error:', error);
                }
                callback([]);
            }
        }

        const debouncedSearch = debounce((query, callback) => {
            searchLocation(query, callback);
        }, 500);

        function setupAutocomplete(inputId, suggestionsId, coordsCallback) {
            const input = document.getElementById(inputId);
            const suggestionsList = document.getElementById(suggestionsId);

            input.addEventListener('input', function() {
                const query = this.value.trim();

                if (query.length < 3) {
                    suggestionsList.classList.remove('active');
                    return;
                }

                debouncedSearch(query, function(results) {
                    suggestionsList.innerHTML = '';
                    
                    if (results.length === 0) {
                        suggestionsList.classList.remove('active');
                        return;
                    }

                    const fragment = document.createDocumentFragment();
                    
                    results.forEach(result => {
                        const item = document.createElement('div');
                        item.className = 'suggestion-item';
                        
                        const name = document.createElement('div');
                        name.className = 'suggestion-name';
                        name.textContent = result.display_name.split(',')[0];
                        
                        const detail = document.createElement('div');
                        detail.className = 'suggestion-detail';
                        detail.textContent = result.display_name;
                        
                        item.appendChild(name);
                        item.appendChild(detail);
                        
                        item.addEventListener('click', function(e) {
                            e.stopPropagation();
                            input.value = result.display_name;
                            coordsCallback({
                                lat: parseFloat(result.lat),
                                lon: parseFloat(result.lon),
                                name: result.display_name
                            });
                            suggestionsList.classList.remove('active');
                        });
                        
                        fragment.appendChild(item);
                    });
                    
                    suggestionsList.appendChild(fragment);
                    suggestionsList.classList.add('active');
                });
            });

            document.addEventListener('click', function(e) {
                if (!input.contains(e.target) && !suggestionsList.contains(e.target)) {
                    suggestionsList.classList.remove('active');
                }
            });
        }

        let isCalculating = false;

        async function calculateRoute() {
            if (!originCoords || !destinationCoords) {
                showError('Please select both origin and destination from the suggestions');
                return;
            }

            if (isCalculating) {
                return;
            }

            isCalculating = true;
            document.getElementById('loading').classList.add('active');
            document.getElementById('errorMessage').classList.remove('active');
            document.getElementById('routeInfo').classList.remove('active');
            document.getElementById('calculateBtn').disabled = true;

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);
                
                const response = await fetch(
                    `https://router.project-osrm.org/route/v1/driving/${originCoords.lon},${originCoords.lat};${destinationCoords.lon},${destinationCoords.lat}?overview=full&geometries=geojson&steps=true&alternatives=true`,
                    { signal: controller.signal }
                );
                
                clearTimeout(timeoutId);
                const data = await response.json();
                
                if (data.code !== 'Ok' || !data.routes || data.routes.length === 0) {
                    throw new Error('No route found');
                }

                currentRouteData = data.routes[0];
                
                displayRoute(currentRouteData);
                setTimeout(() => findLandmarks(currentRouteData), 100);
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    showError('Request timeout. Please try again.');
                } else {
                    showError('Could not calculate route. Please try different locations.');
                }
                console.error('Routing error:', error);
            } finally {
                document.getElementById('loading').classList.remove('active');
                document.getElementById('calculateBtn').disabled = false;
                isCalculating = false;
            }
        }

        function displayRoute(route) {
            if (routeLayer) map.removeLayer(routeLayer);
            if (originMarker) map.removeLayer(originMarker);
            if (destinationMarker) map.removeLayer(destinationMarker);

            const coordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
            routeLayer = L.polyline(coordinates, {
                color: '#FFD700',
                weight: 6,
                opacity: 0.8,
                smoothFactor: 1
            }).addTo(map);

            const originIcon = L.divIcon({
                className: 'custom-marker',
                html: '<div style="background: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%); width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">A</div>',
                iconSize: [35, 35]
            });

            const destIcon = L.divIcon({
                className: 'custom-marker',
                html: '<div style="background: linear-gradient(135deg, #F44336 0%, #EF5350 100%); width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">B</div>',
                iconSize: [35, 35]
            });

            originMarker = L.marker([originCoords.lat, originCoords.lon], { icon: originIcon }).addTo(map);
            destinationMarker = L.marker([destinationCoords.lat, destinationCoords.lon], { icon: destIcon }).addTo(map);

            map.fitBounds(routeLayer.getBounds(), { 
                padding: [50, 50],
                animate: true,
                duration: 0.5
            });

            const distanceKm = (route.distance / 1000).toFixed(1);
            const durationHours = Math.floor(route.duration / 3600);
            const durationMinutes = Math.floor((route.duration % 3600) / 60);
            const estimatedTolls = Math.max(1, Math.floor(route.distance / 100000));
            
            requestAnimationFrame(() => {
                document.getElementById('distance').textContent = distanceKm + ' km';
                document.getElementById('duration').textContent = 
                    durationHours > 0 ? `${durationHours}h ${durationMinutes}m` : `${durationMinutes}m`;
                document.getElementById('tolls').textContent = estimatedTolls;
                document.getElementById('originAddress').textContent = originCoords.name;
                document.getElementById('destinationAddress').textContent = destinationCoords.name;
                
                document.getElementById('routeInfo').classList.add('active');
            });
        }

        async function findLandmarks(route) {
            try {
                const coords = route.geometry.coordinates;
                const totalPoints = coords.length;
                
                const sampleIndices = [
                    Math.floor(totalPoints * 0.2),
                    Math.floor(totalPoints * 0.35),
                    Math.floor(totalPoints * 0.5),
                    Math.floor(totalPoints * 0.65),
                    Math.floor(totalPoints * 0.8)
                ];

                const landmarks = [];
                
                for (let i = 0; i < Math.min(sampleIndices.length, 5); i++) {
                    const idx = sampleIndices[i];
                    const [lon, lat] = coords[idx];
                    
                    try {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 3000);
                        
                        const response = await fetch(
                            `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=10`,
                            { signal: controller.signal }
                        );
                        
                        clearTimeout(timeoutId);
                        const data = await response.json();
                        
                        if (data && data.display_name) {
                            const parts = data.display_name.split(',');
                            const name = parts[0].trim() || parts[1]?.trim() || 'Checkpoint';
                            const type = data.address?.city ? 'City' : 
                                       data.address?.town ? 'Town' : 
                                       data.address?.village ? 'Village' :
                                       data.address?.industrial ? 'Industrial Area' : 'Waypoint';
                            
                            landmarks.push({ name, type });
                        }
                    } catch (error) {
                        if (error.name !== 'AbortError') {
                            console.error('Landmark fetch error:', error);
                        }
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
                
                displayLandmarks(landmarks);
            } catch (error) {
                console.error('Landmark search error:', error);
                displayLandmarks([]);
            }
        }

        function displayLandmarks(landmarks) {
            const landmarksList = document.getElementById('landmarksList');
            
            requestAnimationFrame(() => {
                landmarksList.innerHTML = '';
                
                if (landmarks.length === 0) {
                    landmarksList.innerHTML = '<div style="text-align: center; color: #8D6E63; font-size: 12px; padding: 10px;">No landmarks found along this route</div>';
                    return;
                }
                
                const fragment = document.createDocumentFragment();
                
                landmarks.forEach(landmark => {
                    const item = document.createElement('div');
                    item.className = 'landmark-item';
                    
                    const name = document.createElement('div');
                    name.className = 'landmark-name';
                    name.textContent = landmark.name;
                    
                    const type = document.createElement('div');
                    type.className = 'landmark-type';
                    type.textContent = landmark.type;
                    
                    item.appendChild(name);
                    item.appendChild(type);
                    fragment.appendChild(item);
                });
                
                landmarksList.appendChild(fragment);
            });
        }

        function confirmAndProceed() {
            if (!currentRouteData || !originCoords || !destinationCoords) {
                showError('Route not calculated yet. Please calculate route first.');
                return;
            }
            
            const distanceKm = (currentRouteData.distance / 1000).toFixed(1);
            const durationHours = Math.floor(currentRouteData.duration / 3600);
            const durationMinutes = Math.floor((currentRouteData.duration % 3600) / 60);
            const estimatedTolls = Math.max(1, Math.floor(currentRouteData.distance / 100000));
            
            const params = new URLSearchParams({
                origin: originCoords.name,
                destination: destinationCoords.name,
                originLat: originCoords.lat,
                originLon: originCoords.lon,
                destLat: destinationCoords.lat,
                destLon: destinationCoords.lon,
                distance: distanceKm,
                duration: durationHours > 0 ? `${durationHours}h ${durationMinutes}m` : `${durationMinutes}m`,
                tolls: estimatedTolls,
                approved: 'true'
            });
            
            const driverClientUrl = 'https://roshitrans.github.io/Track/';
            window.location.href = `${driverClientUrl}?${params.toString()}`;
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            requestAnimationFrame(() => {
                errorDiv.textContent = message;
                errorDiv.classList.add('active');
            });
            
            setTimeout(() => {
                requestAnimationFrame(() => {
                    errorDiv.classList.remove('active');
                });
            }, 5000);
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }

        function initializeApp() {
            initMap();
            
            setupAutocomplete('origin', 'originSuggestions', function(coords) {
                originCoords = coords;
            });
            
            setupAutocomplete('destination', 'destinationSuggestions', function(coords) {
                destinationCoords = coords;
            });
            
            document.getElementById('calculateBtn').addEventListener('click', calculateRoute);
            
            document.getElementById('navigateBtn').addEventListener('click', confirmAndProceed);
            
            document.getElementById('landmarksBtn').addEventListener('click', function() {
                const section = document.getElementById('landmarksSection');
                section.classList.toggle('active');
                this.textContent = section.classList.contains('active') 
                    ? 'HIDE ROUTE LANDMARKS' 
                    : 'VIEW ROUTE LANDMARKS';
            });
            
            document.getElementById('origin').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    document.getElementById('destination').focus();
                }
            });
            
            document.getElementById('destination').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    if (originCoords && destinationCoords) {
                        calculateRoute();
                    }
                }
            });

            setInterval(() => {
                const now = Date.now();
                for (const [key, value] of searchCache.entries()) {
                    if (now - value.timestamp > CACHE_EXPIRY) {
                        searchCache.delete(key);
                    }
                }
            }, 600000);
        }
    </script>
</body>
</html>
